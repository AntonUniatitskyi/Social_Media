{% extends 'social/base.html' %}

{% block title %}
    –ì–ª–∞–≤–Ω–∞—è
{% endblock title %}

{% block content %}

<div class="flex flex-col xl:flex-row gap-4 px-2 sm:px-4">

    <div class="hidden xl:block w-1/5 mt-3 mb-10 pl-3 pt-3 pb-20 overflow-y-auto sticky top-10 home-card rounded-2xl border border-gray-300 shadow-xl max-h-[calc(100vh-85px)]">
        <div class="container">
            <!-- Favorites Section -->
            <a href="{% url 'favorites_chat' %}"
               class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-800 gol-s rounded-xl transition-all duration-200 mb-6 shadow-sm">
                <span class="text-yellow-500 text-xl">‚≠ê</span>
                <span class="font-semibold">–í–∏–±—Ä–∞–Ω–µ</span>
            </a>

            <h2 class="text-xl font-bold mb-4 text-gray-800">üì© –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥–æ –≥—Ä—É–ø</h2>

            {% if invites %}
                <ul class="space-y-6">
                    {% for invite in invites %}
                        {% if invite.accepted is None %}
                            <li class="p-2 rounded-2xl border border-gray-200 shadow-md hover:shadow-xl transition duration-300" style="background-color: #beb3ab;">
                                <div class="flex items-start gap-2">
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-700 leading-relaxed">
                                            <span class="font-semibold text-gray-900">{{ invite.from_user.username }}</span>
                                            –∑–∞–ø—Ä–æ—Å–∏–≤ —Ç–µ–±–µ —É –≥—Ä—É–ø—É
                                            <span class="font-semibold text-gray-900">{{ invite.chat_group.group_chat_name }}</span>.
                                        </p>
                                        <div class="mt-2 flex gap-1 flex-col">
                                            <a href="{% url 'respond_to_invite' invite.id 'accept' %}"
                                               class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white rounded-xl hover:bg-green-600 transition shadow" style="background-color: #5e8677; color: #ede6dbf1;">
                                                ‚úÖ –ü—Ä–∏–π–Ω—è—Ç–∏
                                            </a>
                                            <a href="{% url 'respond_to_invite' invite.id 'reject' %}"
                                               class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white rounded-xl hover:bg-red-600 transition shadow" style="background-color: #bf3535; color: #ede6dbf1;">
                                                ‚ùå –í—ñ–¥—Ö–∏–ª–∏—Ç–∏
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center text-gray-500 py-8">
                    <p class="text-sm">üîï –ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞–ø—Ä–æ—à–µ–Ω—å.</p>
                </div>
            {% endif %}
        </div>
    </div>


    <div class="w-full xl:w-3/5 max-w-full mx-auto px-2 sm:px-4 profile-container profile-acc">
        {% if home %}
            <div class="posts-list">
                {% for publication in home %}
                    <!-- Floating card: –°–∫–∞—Ä–≥–∏ -->
                    <div id="complainCard-{{ publication.id }}" class="floating-card window-p">
                        <div class="card-inner shadow-lg rounded-3 p-3 bg-white border">
                            <div class="card-header d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h5 class="mb-0">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å</h5>
                                <span class="close-btn fs-4 cursor-pointer" onclick="toggleCard('complainCard-{{ publication.id }}')">&times;</span>
                            </div>
                            <div class="card-body">
                                {% if complaint %}
                                    <form method="post" action="{% url 'add_complaint' publication.id %}">
                                        {% csrf_token %}
                                        <input type="hidden" name="publication_id" value="{{ publication.id }}">

                                        <div class="mb-3">
                                            <label for="id_reason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞</label>
                                            {{ complaint.reason }}
                                        </div>

                                        <div class="mb-3">
                                            <label for="id_text" class="form-label">–î–µ—Ç–∞–ª—ñ</label>
                                            {{ complaint.text }}
                                        </div>

                                        <button type="submit" class="btn btn-danger w-100">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="post-page-container shadow-xl home-card flex flex-col md:flex-col
                    space-y-4 md:space-y-0" data-publication-id="{{ publication.id }}">

                        <!-- üîπ –í–µ—Ä—Ö: –•–µ–¥–µ—Ä (–∞–≤–∞—Ç–∞—Ä, –∏–º—è, —Å–∫–∞—Ä–≥–∞) -->
                        <div class="flex justify-between items-center mt-3 px-4 md:flex-row md:items-start md:space-x-4">
                            <div class="flex items-center space-x-3">
                                <img src="{{ publication.profile.get_avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <strong>
                                        {% if publication.profile.user.username == user.username %}
                                            <a href="{% url 'account' %}">{{ publication.profile.user.username }}</a>
                                        {% else %}
                                            <a href="{% url 'profile' publication.profile.user.username %}">{{ publication.profile.user.username }}</a>
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                            <button onclick="toggleCard('complainCard-{{ publication.id }}')" class="text-sm text-red-500">–°–∫–∞—Ä–≥–∞</button>
                        </div>

                        <!-- üîπ –ú–µ–¥—ñ–∞ -->
                        <div class="post-media w-full">
                            <div class="media_container mx-auto max-w-[300px] w-full px-4">
                                {% if publication.media_items.all %}
                                    <div class="swiper swiper-{{ publication.id }} w-full">
                                        <div class="swiper-wrapper">
                                            {% for media in publication.media_items.all %}
                                                <div class="swiper-slide">
                                                    {% if media.is_image %}
                                                        <img src="{{ media.file.url }}" class="w-full max-h-[80vh] object-contain rounded-[10px]" alt="–ü—É–±–ª–∏–∫–∞—Ü–∏—è">
                                                    {% elif media.is_video %}
                                                        <video src="{{ media.file.url }}" controls class="w-full max-h-[80vh] object-contain rounded-[10px]"></video>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="swiper-button-next"></div>
                                        <div class="swiper-button-prev"></div>
                                        <div class="swiper-pagination"></div>
                                    </div>
                                {% else %}
                                    <div class="text-center text-white">–ë–µ–∑ –º–µ–¥—ñ–∞</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="post-text px-4">
                            <p class="text-gray-700 text-base">{{ publication.text }}</p>
                            <small class="text-gray-500">{{ publication.timestamp|date:"d.m.Y H:i" }}</small>
                        </div>
                        <!-- üîπ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                        <div class="post-comments comment-block px-4" data-publication-id="{{ publication.id }}" style="max-height: 250px; overflow-y: auto; padding-right: 10px;">
                            {% for comment in publication.comments.all %}
                                <div class="mb-4">
                                    <strong>{{ comment.user.user.username }}</strong>: {{ comment.text_com }}
                                    <small class="block text-gray-500">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                </div>
                            {% empty %}
                                <p class="text-gray-500">–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –Ω–µ–º–∞</p>
                            {% endfor %}
                        </div>

                        <!-- üîπ –õ–∞–π–∫–∏ –∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è -->
                        <div class="post-actions px-4">
                            <div class="flex items-center space-x-4 mb-2">
                                <form method="post" action="{% url 'like_publ' publication.id %}" data-publication-id="{{ publication.id }}" class="like-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn p-0 like">
                                        {% if publication.liked_by_user %}
                                            <ion-icon name="paw" class="text-red-600 text-2xl"></ion-icon>
                                        {% else %}
                                            <ion-icon name="paw-outline" class="text-2xl"></ion-icon>
                                        {% endif %}
                                    </button>
                                    <span class="like-count ml-2 text-gray-700">{{ publication.likes_count }}</span>
                                </form>
                                <button type="button" onclick="copyPublicationLink('{{ publication.id }}')">
                                    <ion-icon name="arrow-redo" class="w-6 h-6"></ion-icon>
                                </button>
                                <div class="!ml-auto">
                                    <button class="save-btn" data-id="{{ publication.id }}">
                                        {% if publication.saved_by_user %}
                                            <i class="fa-solid fa-bookmark text-black-500"></i>  {# —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ #}
                                        {% else %}
                                            <i class="fa-regular fa-bookmark"></i>  {# –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ #}
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- üîπ –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏—è -->
                        <div class="px-4 mb-3">
                            <form method="post" action="{% url 'create_comment' %}" class="comment-form flex flex-col space-y-2">
                                {% csrf_token %}
                                <input type="hidden" name="publication_id" value="{{ publication.id }}">
                                <div class="relative w-full">
                                    {{ form.text_com }}
                                    <button type="submit" class="absolute bottom-1.5 right-2">
                                        <ion-icon name="paper-plane" class="h-5 w-5 text-gray-700"></ion-icon>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <hr>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-posts">
                <p style="font-size: 18px;">–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π</p>
            </div>
        {% endif %}
    </div>

    <div class="hidden xl:block w-1/5 mt-3 mb-10 pl-3 pt-3 pb-20 overflow-y-auto sticky top-10 home-card rounded-lg border border-gray-300 shadow-lg max-h-[calc(100vh-85px)]">
        <!-- Profile Section -->
        <p class="text-center mb-4 font-semibold text-lg text-gray-800">-- –ü—Ä–æ—Ñ—ñ–ª—å --</p>
        <div class="post-header-text flex items-center mb-4">
            <img src="{{ user.profile.get_avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-16 h-16 rounded-full object-cover">
            <div class="ml-4">
                <strong class="text-lg">{{ user.username }}</strong>
                <small class="text-gray-600">@ {{ user.profile.uusername }}</small>
            </div>
        </div>
        <small class="text-right ml-auto mr-3 text-sm" style="color: #3d3d3d;">
            <a href="{% url 'account' %}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ—ñ–ª—å</a>
        </small>
        <hr class="mt-4 mb-4 mr-3 bg-gray-300">

        <!-- Info Section -->
        <p class="text-center mb-4 font-semibold text-lg text-gray-800">-- –Ü–Ω—Ñ–æ --</p>
        <div class="flex flex-row mb-4">
            <button type="button" class="gol-s text-black py-2 px-3 rounded-lg" onclick="toggleCard('followersCard')">{{ user.profile.followers_count }} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</button>
            <button type="button" class="gol-s ml-auto mr-3 text-black py-2 px-3 rounded-lg" onclick="toggleCard('followingCard')">{{ user.profile.following_count }} –ø—ñ–¥–ø–∏—Å–æ–∫</button>
        </div>
        <hr class="mt-4 mb-4 mr-3 bg-gray-300">

        <!-- Recommendations Section -->
        <p class="text-center mb-4 font-semibold text-lg text-gray-800">-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó --</p>
        {% for rec in recomended %}
            <div class="post-header-text flex items-center mb-4">
                <img src="{{ rec.profile.get_avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-12 h-12 rounded-full object-cover">
                <div class="ml-4 flex flex-col">
                    <strong class="text-lg">{{ rec.username }}</strong>
                    <small class="text-gray-600">–í–∏ –∑–Ω–∞–π–æ–º—ñ?</small>
                </div>
                <small class="text-right ml-auto mr-3 text-sm" style="color: rgb(103, 103, 85);">
                    <a href="{% url 'profile' rec.username %}" target="_blank">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</a>
                </small>
            </div>
        {% endfor %}
    </div>

<div id="followersCard" class="floating-card window-p">
    <div class="card-inner">
        <div class="card-header">
            <h5>–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏</h5>
            <span class="close-btn" onclick="toggleCard('followersCard')">&times;</span>
        </div>
        <div class="card-body">
            {% for follower in followers %}
                <div class="follower-item">
                    <img src="{{ follower.profile.get_avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 50px; height: 50px; border-radius: 50%;">
                    <div>
                        <p><a href="{% url 'profile' follower.username %}">{{ follower.username }}</a></p>
                        <small>@ {{ follower.profile.uusername }}</small>
                    </div>
                </div>
            {% empty %}
                <p>–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</p>
            {% endfor %}
        </div>
    </div>
</div>


<!-- Floating card: –ü—ñ–¥–ø–∏—Å–∫–∏ -->
<div id="followingCard" class="floating-card window-p">
    <div class="card-inner">
        <div class="card-header">
            <h5>–ü—ñ–¥–ø–∏—Å–∫–∏</h5>
            <span class="close-btn" onclick="toggleCard('followingCard')">&times;</span>
        </div>
        <div class="card-body">
            {% for followed in following %}
                <div class="follower-item">
                    <img src="{{ followed.profile.get_avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 50px; height: 50px; border-radius: 50%;">
                    <div>
                        <p><a href="{% url 'profile' followed.username %}">{{ followed.username }}</a></p>
                        <small>@ {{ followed.profile.uusername }}</small>
                    </div>
                </div>
            {% empty %}
                <p>–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–æ–∫</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function toggleCard(id) {
        const card = document.getElementById(id);
        card.style.display = card.style.display === 'block' ? 'none' : 'block';
    }

    document.addEventListener('DOMContentLoaded', function () {
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        window.addEventListener('click', function (e) {
            document.querySelectorAll('.floating-card').forEach(card => {
                if (!card.contains(e.target) && !e.target.matches('button')) {
                    card.style.display = 'none';
                }
            });
        });

        document.querySelectorAll('.swiper').forEach(el => {
            const swiperInstance = new Swiper(el, {
                loop: false,
                centeredSlides: true,
                slidesPerView: 1,
                pagination: {
                    el: el.querySelector('.swiper-pagination'),
                    clickable: true,
                },
                navigation: {
                    nextEl: el.querySelector('.swiper-button-next'),
                    prevEl: el.querySelector('.swiper-button-prev'),
                },
                observer: true,
                observeParents: true,
                });

            el.querySelectorAll('img, video').forEach(media => {
                media.addEventListener('load', () => swiperInstance.update());
                media.addEventListener('loadeddata', () => swiperInstance.update());
            });

            window.addEventListener('resize', () => swiperInstance.update());
        });

        // AJAX –ª–∞–π–∫–∏
        document.querySelectorAll('.like-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const publicationId = this.dataset.publicationId;
                const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch(`/like/${publicationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const icon = this.querySelector('ion-icon');
                        icon.name = data.liked ? 'paw' : 'paw-outline';
                        icon.style.color = data.liked ? 'rgb(154, 0, 0)' : '';
                        this.querySelector('.like-count').textContent = `${data.likes_count}`;
                    }
                });
            });
        });

        // AJAX –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        document.querySelectorAll('.comment-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
                const publicationId = formData.get('publication_id');
                const commentBlock = document.querySelector(`.comment-block[data-publication-id="${publicationId}"]`);

                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const newComment = document.createElement('div');
                        newComment.style.marginBottom = '15px';
                        newComment.innerHTML = `
                            <strong>${data.username}</strong>: ${data.text}
                            <small style="color: #888; display: block;">${data.timestamp}</small>
                        `;
                        commentBlock.appendChild(newComment);
                        const textInput = form.querySelector('textarea, input[name="text_com"]');
                        if (textInput) textInput.value = '';
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                });
            });
        });

        // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫/—Ç–∞–ø –¥–ª—è –ª–∞–π–∫–æ–≤
        document.querySelectorAll('.swiper-slide img').forEach(img => {
            let lastTap = 0;
            const heart = document.createElement('ion-icon');
            heart.name = 'paw';
            heart.classList.add('heart-animation');
            img.style.position = 'relative';
            img.parentElement.style.position = 'relative';
            img.parentElement.appendChild(heart);

            function triggerLike(imgElement) {
                const container = imgElement.closest('.post-page-container');
                const publicationId = container?.dataset.publicationId;
                const form = container.querySelector('.like-form');

                if (form) {
                    form.querySelector('button[type="submit"]').click();
                }
                heart.classList.add('show');
                setTimeout(() => heart.classList.remove('show'), 600);
            }

            img.addEventListener('touchend', function () {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    triggerLike(this);
                }
                lastTap = currentTime;
            });

            img.addEventListener('dblclick', function () {
                triggerLike(this);
            });
        });

        // AJAX –¥–ª—è —Ñ–æ—Ä–º—ã –∂–∞–ª–æ–±—ã
        document.querySelectorAll('[id^="complain-form-"]').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
                const publicationId = this.id.split('-').pop(); // –ò–∑–≤–ª–µ–∫–∞–µ–º publication.id –∏–∑ id —Ñ–æ—Ä–º—ã

                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–°–∫–∞—Ä–≥–∞ —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–∞!');
                        toggleCard(`complainCard-${publicationId}`); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                        form.reset(); // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    } else {
                        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —Å–∫–∞—Ä–≥–∏: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —Å–∫–∞—Ä–≥–∏');
                });
            });
        });
    });
</script>

<script>
    function copyPublicationLink(publicationId) {
        const url = `${window.location.origin}/publication/${publicationId}/`;
        navigator.clipboard.writeText(url)
            .then(() => alert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!"))
            .catch(() => alert("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è"));
    }
</script>
<script>
    document.querySelectorAll('.save-btn').forEach(button => {
    button.addEventListener('click', function () {
        const publicationId = this.dataset.id;

        fetch('{% url "get_save_publication" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({ publication_id: publicationId })
        })
        .then(response => response.json())
        .then(data => {
        const icon = this.querySelector('i');
        if (data.saved) {
            icon.classList.remove('fa-regular');
            icon.classList.add('fa-solid', 'text-black-500');
        } else {
            icon.classList.remove('fa-solid', 'text-black-500');
            icon.classList.add('fa-regular');
        }
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error));
    });
    });

</script>
{% endblock content %}
